# 位置上报（HassTools）

通过手机端主动、智能地向 Home Assistant 服务器上报实时位置。

解决官方 APP 定位更新慢、耗电重等问题，让基于 `device_tracker` 的自动化更可靠。

---

## 安装与更新

### 从 Releases 安装

前往 GitHub Releases 下载并安装 APK。

Release 版本未预置高德 API Key，若要启用高德融合定位，请在应用内或构建时自行配置。

### 用 Android Studio 构建（可内置高德）

克隆仓库后，用 Android Studio 打开项目即可构建。

若希望在构建阶段内置高德 API Key，在项目根目录创建或编辑 `local.properties` 并加入：

```properties
AMAP_API_KEY=你的高德Key
```

加入后，应用内的 API Key 配置入口将不再显示。也可以不在构建期写入，安装后可在应用内填写。

### 验证安装

首次打开 APP，完成用户向导并连接到你的 Home Assistant 服务器。

随后在 Home Assistant 确认对应 `device_tracker` 的状态与坐标。

### 重要说明

* 手机厂商通常对应用后台活动有严格限制，需要在系统电池/后台管理中将本应用设为 `允许后台活动` 或 `不受限制`。部分 ROM 还需 `锁定应用进程` 与 `允许开机自启`。

---

## 使用

### 首次连接 Home Assistant

在用户页按向导添加服务器与用户，可选择两种方式完成与 `device_tracker` 的绑定：

1. 注册新的 `device_tracker`，由本应用自动创建；
2. 复用已有的 `device_tracker`：若你已抓包获得该实体的 Webhook ID，可直接填入以完成绑定。

支持在一台手机上同时给多台 Home Assistant 服务器上报位置。

### 基础定位

回到首页启用基础定位。APP 会按 1–15 分钟的动态间隔主动上报位置，间隔由移动速度自适应。

定位提供链路按“融合 → 网络 → GPS → 被动”依次回退

* 单次请求 10 秒无结果即切换下一种定位方式，兼顾时效与能耗。
* 旨在提供实时定位兜底机制，适用于对实时性不高的场景。如需增强实时性，请按需启用下文所述的各项辅助功能。
* 手机定位并非 100% 准确，当出现定位偏移时，极有可能误触自动化。建议合理配置“地理围栏”，以减少自动化误触。

> 🔋 荣耀 Magic 6 Pro 手机启用全部辅助功能使用 7×24 小时，每日仅消耗约 20–70 mAh 电量，每日平均定位约 250 次。不同设备与系统策略可能不同，结果会有差异。

### 网络状态触发器

在设置页开启“网络状态触发器”。当网络从固定 Wi-Fi（非按流量计费）切到其它网络，或从其它网络切回固定 Wi-Fi 时，APP 会额外触发一次计划外定位：

* 切入固定 Wi-Fi：延迟 1 秒触发；
* 切出固定 Wi-Fi：延迟 1 分钟触发（避免“刚出门”仍贴近接入点导致误判）。

### Wi-Fi 地理围栏

以 Wi-Fi 设备作为围栏参照，提供两项增强逻辑：

* **离开保护**：若定位显示“离开”，但手机仍能扫描到围栏内指定的 Wi-Fi，判定为定位漂移，不改变 `device_tracker` 的进/出状态（仍会上报坐标）。
* **快速进入**：现实中手机扫描到附近 Wi-Fi 往往早于 GPS/融合定位收敛。当扫描到围栏内 Wi-Fi 时，直接用围栏坐标作为设备坐标上报，实现“到家即到位”。

### 自定义网络偏好

你可以强制仅使用移动数据上报、或禁用代理。这既能提升隐私与可靠性（避免公共 Wi-Fi/代理的明文劫持），也能在网络切换阶段保持连续上报。

### 步数推送

国内厂商通常不会把当日步数同步到 Health Connect，导致 Home Assistant 无法获取当日步数。

我知道，这与位置上报无关——

但是本应用确实可以把手机步数传感器的数据推送到 Health Connect。

---

## 常见问题

### 后台被系统杀掉怎么办？

在系统电池/后台管理中将本应用设为 `允许后台活动` 或 `不受限制`。部分 ROM 还需 `锁定应用进程` 与 `允许开机自启`。

### 无法使用高德融合定位？

确认已在应用内填写 API Key，或在构建期通过 `local.properties` 写入 `AMAP_API_KEY`。

### 我担心在公共 Wi-Fi 泄露隐私。

在设置里将上报网络设为移动数据并禁用代理即可。

---

## 许可协议

本项目以 AGPL-3.0 开源发布。
